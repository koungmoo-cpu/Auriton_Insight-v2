<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auriton InsightAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+KR:wght@300;500;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-deep: #0B0E14; --text-main: #e0e0e0; --primary-purple: #b026ff; --primary-cyan: #00f2ff; --primary-pink: #ff0055; --accent-gold: #ffd700; --glass: rgba(20, 15, 35, 0.8); }
        body { background: var(--bg-deep); color: var(--text-main); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; overflow-x: hidden; }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000 url('https://raw.githubusercontent.com/hudsonm62/stars/master/star_bg.png'); z-index: -2; opacity: 0.5; }
        
        /* UI Components */
        .screen { display: none; padding: 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header-title { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--accent-gold); text-align: center; margin: 40px 0 10px; text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .header-sub { text-align: center; color: var(--primary-cyan); font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 40px; opacity: 0.7; }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .method-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .method-card:hover { transform: translateY(-5px); border-color: var(--color); box-shadow: 0 0 20px var(--glow); }
        .icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        
        .form-box { background: rgba(10,10,20,0.95); border: 1px solid #333; border-radius: 12px; padding: 25px; border-top: 3px solid var(--theme); }
        .input-group { margin-bottom: 20px; }
        .label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; font-family: 'Orbitron'; }
        .input, .select { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; font-size: 1rem; outline: none; }
        .input:focus { border-color: var(--accent-gold); }
        
        .btn-group { display: flex; gap: 10px; }
        .opt-btn { flex: 1; padding: 12px; background: #1a1a1a; border: 1px solid #444; color: #aaa; border-radius: 6px; cursor: pointer; text-align: center; }
        .opt-btn.active { background: rgba(255,255,255,0.1); border-color: var(--accent-gold); color: var(--accent-gold); font-weight: bold; }
        
        .action-btn { width: 100%; padding: 16px; font-weight: bold; font-family: 'Orbitron'; cursor: pointer; border: none; border-radius: 6px; margin-top: 10px; transition: 0.2s; }
        .action-btn:active { transform: scale(0.98); }

        /* Compatibility Tabs */
        .tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #666; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab.active { color: var(--primary-pink); border-bottom: 2px solid var(--primary-pink); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Chat Result */
        .chat-container { border: 1px solid var(--primary-purple); background: rgba(0,0,0,0.8); height: 60vh; display: flex; flex-direction: column; border-radius: 8px; overflow: hidden; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; font-size: 0.95rem; line-height: 1.6; }
        .ai-msg { color: #ddd; margin-bottom: 20px; white-space: pre-wrap; animation: textFade 0.5s; border-left: 3px solid var(--accent-gold); padding-left: 15px; }
        .user-msg { color: var(--primary-cyan); text-align: right; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; display: inline-block; margin-left: auto; max-width: 80%; }
        .strong-hl { color: var(--accent-gold); font-weight: bold; }

        /* Chat Input Area */
        .chat-input-area { display: flex; border-top: 1px solid #333; padding: 10px; background: #050510; }
        .chat-input { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 4px; outline: none; }
        .send-btn { background: var(--accent-gold); color: black; font-weight: bold; border: none; padding: 0 20px; margin-left: 10px; border-radius: 4px; cursor: pointer; font-family: 'Orbitron'; }

        @media (max-width: 480px) { .header-title { font-size: 1.5rem; } }
    </style>
</head>
<body>
    <div class="stars"></div>

    <section id="screen-select" class="screen active">
        <h1 class="header-title">AURITON INSIGHT AI</h1>
        <p class="header-sub">DESTINY ANALYSIS SYSTEM</p>
        <div class="card-grid">
            <div class="method-card" onclick="goSaju()" style="--color:var(--primary-purple); --glow:rgba(176,38,255,0.3)">
                <span class="icon">ğŸ”®</span>
                <h3>ì •í†µ ì‚¬ì£¼ & ëŒ€ìš´</h3>
                <p style="font-size:0.8rem; color:#888; margin-top:10px">íƒ€ê³ ë‚œ ëª…ì‹ê³¼<br>10ë…„ ëŒ€ìš´ì˜ íë¦„ ë¶„ì„</p>
            </div>
            <div class="method-card" onclick="goCouple()" style="--color:var(--primary-pink); --glow:rgba(255,0,85,0.3)">
                <span class="icon">ğŸ’</span>
                <h3>ìš´ëª… ê¶í•©</h3>
                <p style="font-size:0.8rem; color:#888; margin-top:10px">ë‘ ì‚¬ëŒì˜ ì—ë„ˆì§€ ì¡°í™”ì™€<br>ê´€ê³„ ë°œì „ ì¡°ì–¸</p>
            </div>
            <div class="method-card" onclick="goAstrology()" style="--color:var(--primary-cyan); --glow:rgba(0,242,255,0.3)">
                <span class="icon">ğŸŒŒ</span>
                <h3>ì„œì–‘ ì ì„±ìˆ </h3>
                <p style="font-size:0.8rem; color:#888; margin-top:10px">ë³„ë“¤ì˜ ë°°ì¹˜ë¡œ ë³´ëŠ”<br>ë‚´ë©´ì˜ ì‹¬ë¦¬ ë¶„ì„</p>
            </div>
        </div>
    </section>

    <section id="screen-saju" class="screen">
        <button onclick="goHome()" style="color:#666; background:none; border:none; margin-bottom:10px">â—€ BACK</button>
        <div class="form-box" style="--theme:var(--primary-purple)">
            <h2 style="color:white; margin-bottom:20px; font-family:'Orbitron'">SAJU DATA</h2>
            <form id="form-saju" onsubmit="submitSaju(event)">
                <div class="input-group"><label class="label">NAME</label><input type="text" id="s-name" class="input" required></div>
                <div class="input-group"><label class="label">GENDER</label>
                    <div class="btn-group" id="s-gender-box"><div class="opt-btn active" data-val="male">ë‚¨ì„± (M)</div><div class="opt-btn" data-val="female">ì—¬ì„± (F)</div></div>
                </div>
                <div class="input-group"><label class="label">BIRTH DATE (YYYY-MM-DD)</label>
                    <div style="display:flex; gap:5px">
                        <input type="number" id="s-y" class="input" placeholder="Year" style="flex:1.5" required>
                        <input type="number" id="s-m" class="input" placeholder="Mon" style="flex:1" required>
                        <input type="number" id="s-d" class="input" placeholder="Day" style="flex:1" required>
                    </div>
                </div>
                <div class="input-group"><label class="label">BIRTH TIME</label>
                    <input type="time" id="s-time" class="input" required>
                </div>
                <div class="input-group">
                    <label class="label">CALENDAR TYPE</label>
                    <div id="s-cal-box"></div>
                </div>
                <button type="submit" class="action-btn" style="background:var(--primary-purple); color:white">ANALYZE â–¶</button>
            </form>
        </div>
    </section>

    <section id="screen-couple" class="screen">
        <button onclick="goHome()" style="color:#666; background:none; border:none; margin-bottom:10px">â—€ BACK</button>
        <div class="form-box" style="--theme:var(--primary-pink)">
            <h2 style="color:white; margin-bottom:10px; font-family:'Orbitron'">ğŸ’ COUPLE DATA</h2>
            <div style="background:rgba(255,0,85,0.1); padding:10px; border-radius:6px; margin-bottom:20px; border-left:3px solid var(--primary-pink)">
                <p style="color:#ff88aa; font-size:0.85rem; margin:0">
                    ğŸ’¡ <strong style="color:#fff">ì–‘ë ¥/ìŒë ¥ ì„ íƒ ê°€ëŠ¥</strong> - ë‘ ì‚¬ëŒì˜ ë‹¬ë ¥ íƒ€ì…ì„ ê°ê° ì„ íƒí•˜ì„¸ìš”.
                </p>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('A')">Person A (ë‚˜)</div>
                <div class="tab" onclick="switchTab('B')">Person B (ìƒëŒ€)</div>
            </div>

            <div id="tab-A" class="tab-content active">
                <div class="input-group"><label class="label">NAME</label><input type="text" id="c-name-a" class="input" placeholder="ë‚´ ì´ë¦„" required></div>
                <div class="input-group"><label class="label">GENDER</label><select id="c-gender-a" class="select"><option value="male">ë‚¨ì„±</option><option value="female">ì—¬ì„±</option></select></div>
                <div class="input-group">
                    <label class="label">BIRTH DATE</label>
                    <div style="display:flex; gap:5px">
                        <input type="number" id="c-y-a" class="input" placeholder="YYYY" min="1900" max="2100" required>
                        <input type="number" id="c-m-a" class="input" placeholder="MM" min="1" max="12" required>
                        <input type="number" id="c-d-a" class="input" placeholder="DD" min="1" max="31" required>
                    </div>
                </div>
                <div class="input-group">
                    <label class="label">CALENDAR TYPE</label>
                    <div id="c-cal-a"></div>
                </div>
                <div class="input-group"><label class="label">BIRTH TIME (ì„ íƒ)</label><input type="time" id="c-time-a" class="input" placeholder="ëª¨ë¥´ë©´ ë¹„ì›Œë‘ì„¸ìš”"></div>
                <div class="action-btn" onclick="switchTab('B')" style="background:#333; color:#fff; text-align:center; margin-top:20px">NEXT: ìƒëŒ€ë°© ì…ë ¥ â–¶</div>
            </div>

            <div id="tab-B" class="tab-content">
                <div class="input-group"><label class="label">NAME</label><input type="text" id="c-name-b" class="input" placeholder="ìƒëŒ€ë°© ì´ë¦„" required></div>
                <div class="input-group"><label class="label">GENDER</label><select id="c-gender-b" class="select"><option value="female" selected>ì—¬ì„±</option><option value="male">ë‚¨ì„±</option></select></div>
                <div class="input-group">
                    <label class="label">BIRTH DATE</label>
                    <div style="display:flex; gap:5px">
                        <input type="number" id="c-y-b" class="input" placeholder="YYYY" min="1900" max="2100" required>
                        <input type="number" id="c-m-b" class="input" placeholder="MM" min="1" max="12" required>
                        <input type="number" id="c-d-b" class="input" placeholder="DD" min="1" max="31" required>
                    </div>
                </div>
                <div class="input-group">
                    <label class="label">CALENDAR TYPE</label>
                    <div id="c-cal-b"></div>
                </div>
                <div class="input-group"><label class="label">BIRTH TIME (ì„ íƒ)</label><input type="time" id="c-time-b" class="input" placeholder="ëª¨ë¥´ë©´ ë¹„ì›Œë‘ì„¸ìš”"></div>
                <button onclick="submitCouple()" class="action-btn" style="background:var(--primary-pink); color:white; margin-top:20px">CHECK COMPATIBILITY â¤</button>
            </div>
        </div>
    </section>

    <!-- ì ì„±í•™ í™”ë©´ ì¶”ê°€ -->
    <section id="screen-astrology" class="screen">
        <button onclick="goHome()" style="color:#666; background:none; border:none; margin-bottom:10px">â—€ BACK</button>
        <div class="form-box" style="--theme:var(--primary-cyan)">
            <h2 style="color:white; margin-bottom:20px; font-family:'Orbitron'">â­ ASTROLOGY DATA</h2>
            <form id="form-astrology" onsubmit="submitAstrology(event)">
                <div class="input-group">
                    <label class="label">NAME</label>
                    <input type="text" id="a-name" class="input" placeholder="ì´ë¦„" required>
                </div>
                <div class="input-group">
                    <label class="label">GENDER</label>
                    <div class="btn-group" id="a-gender-box">
                        <div class="opt-btn active" data-val="male">ë‚¨ì„±</div>
                        <div class="opt-btn" data-val="female">ì—¬ì„±</div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="label">BIRTH DATE</label>
                    <div style="display:flex; gap:5px">
                        <input type="number" id="a-y" class="input" placeholder="Year" style="flex:2" required>
                        <input type="number" id="a-m" class="input" placeholder="Month" style="flex:1" required>
                        <input type="number" id="a-d" class="input" placeholder="Day" style="flex:1" required>
                    </div>
                </div>
                <div class="input-group">
                    <label class="label">CALENDAR TYPE</label>
                    <div id="a-cal-box"></div>
                    <p style="font-size:0.75rem; color:#66ddff; margin-top:5px; opacity:0.8">
                        ğŸ’¡ ì ì„±í•™ì€ ì¼ë°˜ì ìœ¼ë¡œ ì–‘ë ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
                    </p>
                </div>
                <div class="input-group">
                    <label class="label">BIRTH TIME</label>
                    <input type="time" id="a-time" class="input" required>
                </div>
                <div class="input-group">
                    <label class="label">BIRTH LOCATION</label>
                    <input type="text" id="a-location" class="input" placeholder="ì˜ˆ: ì„œìš¸, ëŒ€í•œë¯¼êµ­" value="ì„œìš¸, ëŒ€í•œë¯¼êµ­">
                </div>
                <button type="submit" class="action-btn" style="background:var(--primary-cyan); color:white">ANALYZE STARS âœ¨</button>
            </form>
        </div>
    </section>

    <section id="screen-result" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h2 class="header-sub" style="margin:0; text-align:left">ANALYSIS RESULT</h2>
            <button onclick="goHome()" style="background:none; border:1px solid #444; color:#888; padding:5px 10px; font-size:0.7rem">NEW SCAN</button>
        </div>
        
        <!-- Fortune Type Buttons (ì‚¬ì£¼ ë¶„ì„ í›„ì—ë§Œ í‘œì‹œ) -->
        <div id="fortune-buttons" style="display:none; margin-bottom:20px; background:rgba(20,15,35,0.6); padding:15px; border-radius:8px; border:1px solid rgba(176,38,255,0.3)">
            <div style="text-align:center; color:#ffd700; font-size:0.8rem; margin-bottom:12px; font-family:'Orbitron'">ğŸ“Š ìš´ì„¸ ìƒì„¸ ë¶„ì„</div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px">
                <button class="fortune-btn" data-fortune="daily" style="padding:10px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì¼ê°„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="weekly" style="padding:10px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì£¼ê°„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="monthly" style="padding:10px; background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì›”ê°„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="yearly" style="padding:10px; background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì˜¬í•´ì˜ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="decade" style="padding:10px; background:linear-gradient(135deg, #fa709a 0%, #fee140 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    10ë…„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="total" style="padding:10px; background:linear-gradient(135deg, #30cfd0 0%, #330867 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì´ìš´
                </button>
            </div>
        </div>

        <!-- Astrology Transit Buttons (ì ì„±í•™ ë¶„ì„ í›„ì—ë§Œ í‘œì‹œ) -->
        <div id="astrology-buttons" style="display:none; margin-bottom:20px; background:rgba(15,30,45,0.6); padding:15px; border-radius:8px; border:1px solid rgba(0,242,255,0.3)">
            <div style="text-align:center; color:#00f2ff; font-size:0.8rem; margin-bottom:12px; font-family:'Orbitron'">ğŸŒŸ í–‰ì„± ìš´í–‰ íë¦„</div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px">
                <button class="astrology-btn" data-transit="monthly" style="padding:10px; background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì›” íë¦„
                </button>
                <button class="astrology-btn" data-transit="yearly" style="padding:10px; background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ë…„ íë¦„
                </button>
                <button class="astrology-btn" data-transit="decade" style="padding:10px; background:linear-gradient(135deg, #fa709a 0%, #fee140 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    10ë…„ íë¦„
                </button>
            </div>
        </div>
        
        <div class="chat-container" style="position:relative">
            <div id="chat-box" class="chat-box"></div>
            
            <!-- ìŠ¤í¬ë¡¤ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
            <div style="position:absolute; right:15px; bottom:70px; display:flex; flex-direction:column; gap:8px; z-index:10">
                <!-- ë§¨ ìœ„ë¡œ ë²„íŠ¼ -->
                <button id="scroll-to-top-btn" onclick="scrollToTop()" 
                        style="display:none; opacity:0; width:45px; height:45px; border-radius:50%; 
                               background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                               border:none; color:white; font-size:1.2rem; cursor:pointer; 
                               box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:all 0.3s;
                               display:flex; align-items:center; justify-content:center"
                        title="ë§¨ ìœ„ë¡œ">
                    â¬†ï¸
                </button>
                
                <!-- ë§¨ ì•„ë˜ë¡œ ë²„íŠ¼ -->
                <button onclick="scrollToBottom()" 
                        style="width:45px; height:45px; border-radius:50%; 
                               background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
                               border:none; color:white; font-size:1.2rem; cursor:pointer; 
                               box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:all 0.3s;
                               display:flex; align-items:center; justify-content:center"
                        onmouseover="this.style.transform='scale(1.1)'"
                        onmouseout="this.style.transform='scale(1)'"
                        title="ë§¨ ì•„ë˜ë¡œ">
                    â¬‡ï¸
                </button>
            </div>
            
            <div class="chat-input-area" id="chat-input-area">
                <input type="text" id="user-msg" class="chat-input" placeholder="ì¶”ê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2026ë…„ ì¬ë¬¼ìš´ì€?)">
                <button onclick="sendChat()" class="send-btn">SEND</button>
            </div>
        </div>
    </section>
    </section>

    <script>
        // ========== ê³µí†µ ì»´í¬ë„ŒíŠ¸: ë‹¬ë ¥ íƒ€ì… ì„ íƒê¸° ==========
        function createCalendarTypeSelector(containerId, defaultType = 'solar', includeLeapMonth = true) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.className = 'btn-group calendar-type-selector';
            
            const options = [
                { value: 'solar', label: 'ì–‘ë ¥', emoji: 'â˜€ï¸' },
                { value: 'lunar', label: 'ìŒë ¥', emoji: 'ğŸŒ™' }
            ];
            
            if (includeLeapMonth) {
                options.push({ value: 'lunar-leap', label: 'ìŒë ¥(ìœ¤)', emoji: 'ğŸŒ™+' });
            }
            
            container.innerHTML = options.map(opt => `
                <div class="opt-btn ${opt.value === defaultType ? 'active' : ''}" 
                     data-val="${opt.value}"
                     title="${opt.label}">
                    <span style="font-size:0.9rem; margin-right:4px">${opt.emoji}</span>
                    ${opt.label}
                </div>
            `).join('');
            
            // í´ë¦­ ì´ë²¤íŠ¸ ìë™ ë“±ë¡
            container.querySelectorAll('.opt-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    container.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        // ========== ê³µí†µ: ë‹¬ë ¥ íƒ€ì… ê°€ì ¸ì˜¤ê¸° ==========
        function getCalendarType(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return 'solar';
            
            const activeBtn = container.querySelector('.opt-btn.active');
            if (!activeBtn) return 'solar';
            
            const val = activeBtn.dataset.val;
            
            // í•œê¸€ë¡œ ë³€í™˜
            switch(val) {
                case 'solar': return 'ì–‘ë ¥';
                case 'lunar': return 'ìŒë ¥';
                case 'lunar-leap': return 'ìŒë ¥(ìœ¤)';
                default: return 'ì–‘ë ¥';
            }
        }
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ì´ê²Œ ìˆì–´ì•¼ ì±„íŒ…ì´ ë©ë‹ˆë‹¤!)
        let currentMode = ''; // 'saju' or 'couple'
        let currentUserInfo = null; // ì‚¬ì£¼ìš©
        let currentCoupleInfo = null; // ê¶í•©ìš©

        // --- Navigation ---
        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
        }
        function goHome() { 
            showScreen('screen-select'); 
            document.getElementById('chat-box').innerHTML = ''; // ì±„íŒ… ì´ˆê¸°í™”
            document.getElementById('fortune-buttons').style.display = 'none'; // ìš´ì„¸ ë²„íŠ¼ ìˆ¨ê¹€
            document.getElementById('astrology-buttons').style.display = 'none'; // ì ì„±í•™ ë²„íŠ¼ ìˆ¨ê¹€
            hideScrollToTopButton(); // ìŠ¤í¬ë¡¤ ë²„íŠ¼ ìˆ¨ê¹€
            currentUserInfo = null; // ë°ì´í„° ì´ˆê¸°í™”
            currentCoupleInfo = null;
            currentMode = '';
        }
        function goSaju() { currentMode = 'saju'; showScreen('screen-saju'); }
        function goCouple() { currentMode = 'couple'; showScreen('screen-couple'); }
        function goAstrology() { currentMode = 'astrology'; showScreen('screen-astrology'); }

        // --- UI Helpers ---
        document.querySelectorAll('.btn-group .opt-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function switchTab(target) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll(`.tab:nth-child(${target === 'A' ? 1 : 2})`)[0].classList.add('active');
            document.getElementById(`tab-${target}`).classList.add('active');
        }

        function appendMsg(sender, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            
            // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
            const wasAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
            
            // AI ë©”ì‹œì§€ëŠ” ì¤„ë°”ê¿ˆ ì²˜ë¦¬ ë° ê°•ì¡° í‘œì‹œ
            if (sender === 'ai') {
                div.className = 'ai-msg';
                div.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<span class="strong-hl">$1</span>');
            } else {
                div.className = 'user-msg';
                div.textContent = text;
            }
            box.appendChild(div);
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ì´ê±°ë‚˜ ì´ë¯¸ ë§¨ ì•„ë˜ì— ìˆì—ˆìœ¼ë©´ ìŠ¤í¬ë¡¤
            if (sender === 'user' || wasAtBottom) {
                box.scrollTop = box.scrollHeight;
            }
            
            // AI ì‘ë‹µì´ ì™„ë£Œë˜ë©´ "ë§¨ ìœ„ë¡œ" ë²„íŠ¼ í‘œì‹œ
            if (sender === 'ai' && !text.includes('ë¶„ì„ ì¤‘') && !text.includes('ê³„ì‚° ì¤‘')) {
                setTimeout(() => {
                    showScrollToTopButton();
                }, 500);
            }
        }

        // ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        function showScrollToTopButton() {
            const btn = document.getElementById('scroll-to-top-btn');
            if (btn) {
                btn.style.display = 'block';
                setTimeout(() => btn.style.opacity = '1', 10);
            }
        }

        function hideScrollToTopButton() {
            const btn = document.getElementById('scroll-to-top-btn');
            if (btn) {
                btn.style.opacity = '0';
                setTimeout(() => btn.style.display = 'none', 300);
            }
        }

        // ì±„íŒ… ë°•ìŠ¤ë¥¼ ë¶€ë“œëŸ½ê²Œ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
        function scrollToTop() {
            const box = document.getElementById('chat-box');
            box.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            hideScrollToTopButton();
        }

        // ì±„íŒ… ë°•ìŠ¤ë¥¼ ë¶€ë“œëŸ½ê²Œ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
        function scrollToBottom() {
            const box = document.getElementById('chat-box');
            box.scrollTo({
                top: box.scrollHeight,
                behavior: 'smooth'
            });
        }

        // --- API Calls ---
        // 1. ê°œì¸ ì‚¬ì£¼ ë¶„ì„
        async function submitSaju(e) {
            e.preventDefault();
            const name = document.getElementById('s-name').value;
            const gender = document.querySelector('#s-gender-box .active').dataset.val;
            const calendarType = getCalendarType('s-cal-box'); // ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
            const y = document.getElementById('s-y').value;
            const m = document.getElementById('s-m').value;
            const d = document.getElementById('s-d').value;
            const t = document.getElementById('s-time').value;

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì±„íŒ…í•  ë•Œ ì”ë‹ˆë‹¤!)
            currentUserInfo = { 
                name, 
                gender, 
                birthDate: `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`, 
                birthTime: t, 
                calendarType: calendarType 
            };
            
            // ì‚¬ì£¼ ëª¨ë“œ ì„¤ì •
            currentMode = "saju";
            
            showScreen('screen-result');
            document.getElementById('chat-input-area').style.display = 'flex';
            
            // âœ¨ ìš´ì„¸ ë²„íŠ¼ í‘œì‹œ
            document.getElementById('fortune-buttons').style.display = 'block';
            
            appendMsg('ai', "ğŸ”® ìš´ëª…ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...\n(ëŒ€ìš´ íë¦„ ê³„ì‚° ì¤‘)");

            try {
                const res = await fetch('/api/saju/consultation', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ rawData: { userInfo: currentUserInfo } })
                });
                const data = await res.json();
                appendMsg('ai', data.consultation);
            } catch(err) { appendMsg('ai', "ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        }

        // 2. ê¶í•© ë¶„ì„
        async function submitCouple() {
            // ë‚ ì§œ ê°’ ê°€ì ¸ì˜¤ê¸°
            const aY = document.getElementById('c-y-a').value;
            const aM = document.getElementById('c-m-a').value;
            const aD = document.getElementById('c-d-a').value;
            const bY = document.getElementById('c-y-b').value;
            const bM = document.getElementById('c-m-b').value;
            const bD = document.getElementById('c-d-b').value;

            // ë‚ ì§œ í˜•ì‹ ê²€ì¦
            if (!aY || !aM || !aD || !bY || !bM || !bD) {
                alert("ë‘ ì‚¬ëŒì˜ ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
                return;
            }

            const aInfo = {
                name: document.getElementById('c-name-a').value,
                gender: document.getElementById('c-gender-a').value,
                birthDate: `${aY}-${String(aM).padStart(2, '0')}-${String(aD).padStart(2, '0')}`,
                birthTime: document.getElementById('c-time-a').value || '12:00',
                calendarType: getCalendarType('c-cal-a') // ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
            };
            const bInfo = {
                name: document.getElementById('c-name-b').value,
                gender: document.getElementById('c-gender-b').value,
                birthDate: `${bY}-${String(bM).padStart(2, '0')}-${String(bD).padStart(2, '0')}`,
                birthTime: document.getElementById('c-time-b').value || '12:00',
                calendarType: getCalendarType('c-cal-b') // ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
            };

            if(!aInfo.name || !bInfo.name) {
                alert("ë‘ ì‚¬ëŒì˜ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
                return;
            }

            // ê¶í•© ëª¨ë“œ
            currentCoupleInfo = { personA: aInfo, personB: bInfo };
            currentMode = 'couple';
            showScreen('screen-result');
            // ê¶í•© ì±„íŒ…ì€ ë³µì¡ë„ê°€ ë†’ì•„ ì¼ë‹¨ ìˆ¨ê¹€ (í•„ìš”ì‹œ í™œì„±í™” ê°€ëŠ¥)
            document.getElementById('chat-input-area').style.display = 'none';

            appendMsg('ai', `ğŸ’ ë‘ ì‚¬ëŒì˜ ì—ë„ˆì§€ë¥¼ ë™ê¸°í™”í•˜ì—¬ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...\n(${aInfo.calendarType}/${bInfo.calendarType} ê¸°ì¤€ìœ¼ë¡œ ì‚¬ì£¼ ê³„ì‚° ì¤‘)`);

            try {
                const res = await fetch('/api/compatibility', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ person1: aInfo, person2: bInfo })
                });
                const data = await res.json();
                
                if (data.success) {
                    appendMsg('ai', data.analysis);
                } else {
                    appendMsg('ai', `âŒ ì˜¤ë¥˜ ë°œìƒ: ${data.error}\n\nì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                }
            } catch(err) { 
                console.error('Compatibility Error:', err);
                appendMsg('ai', "âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); 
            }
        }

        // 3. ì ì„±í•™ ë¶„ì„
        async function submitAstrology(e) {
            e.preventDefault();
            const name = document.getElementById('a-name').value;
            const gender = document.querySelector('#a-gender-box .active').dataset.val;
            const calendarType = getCalendarType('a-cal-box'); // ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
            const y = document.getElementById('a-y').value;
            const m = document.getElementById('a-m').value;
            const d = document.getElementById('a-d').value;
            const t = document.getElementById('a-time').value;
            const location = document.getElementById('a-location').value;

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            currentUserInfo = { 
                name, 
                gender, 
                birthDate: `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`, 
                birthTime: t, 
                location: location,
                calendarType: calendarType // ë‹¬ë ¥ íƒ€ì… ì¶”ê°€
            };
            
            // ì ì„±í•™ ëª¨ë“œ ì„¤ì •
            currentMode = "astrology";
            
            showScreen('screen-result');
            document.getElementById('chat-input-area').style.display = 'flex';
            
            // âœ¨ ì ì„±í•™ ë²„íŠ¼ í‘œì‹œ
            document.getElementById('astrology-buttons').style.display = 'block';
            
            appendMsg('ai', `ğŸŒŒ ë³„ë“¤ì˜ ìœ„ì¹˜ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...\n(${calendarType} ê¸°ì¤€, í–‰ì„± ë°°ì¹˜ ê³„ì‚° ì¤‘)`);

            try {
                const res = await fetch('/api/astrology/consultation', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ rawData: { userInfo: currentUserInfo } })
                });
                const data = await res.json();
                appendMsg('ai', data.consultation);
            } catch(err) { appendMsg('ai', "ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        }

        // 4. ì±„íŒ… ì „ì†¡ (ì—¬ê¸°ê°€ í•µì‹¬!)
        async function sendChat() {
            const input = document.getElementById('user-msg');
            const msg = input.value.trim();
            if (!msg) return;

            // ë‚´ê°€ ì“´ ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
            appendMsg('user', msg);
            input.value = '';

            // ì„œë²„ë¡œ ì „ì†¡ (currentUserInfoë¥¼ ê°™ì´ ë³´ëƒ…ë‹ˆë‹¤!)
            if ((currentMode === 'saju' || currentMode === 'astrology') && currentUserInfo) {
                try {
                    const endpoint = currentMode === 'saju' ? '/api/saju/chat' : '/api/astrology/chat';
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userMessage: msg, 
                            rawData: { userInfo: currentUserInfo } // â˜… í•µì‹¬: ìœ ì € ì •ë³´ ì¬ì „ì†¡
                        })
                    });
                    const data = await res.json();
                    appendMsg('ai', data.answer);
                } catch (e) {
                    appendMsg('ai', "ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                appendMsg('ai', "ë¶„ì„ ë°ì´í„°ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
            }
        }
        
        // ========== Fortune Button Functions ==========
        async function showFortuneByType(fortuneType) {
            if (!currentUserInfo) {
                appendMsg('ai', 'ë¨¼ì € ì‚¬ì£¼ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const fortuneNames = {
                'daily': 'ì˜¤ëŠ˜ì˜ ìš´ì„¸',
                'weekly': 'ì´ë²ˆ ì£¼ ìš´ì„¸',
                'monthly': 'ì´ë²ˆ ë‹¬ ìš´ì„¸',
                'yearly': 'ì˜¬í•´ì˜ ìš´ì„¸',
                'decade': '10ë…„ ìš´ì„¸',
                'total': 'ì´ìš´'
            };

            appendMsg('ai', `ğŸ“Š ${fortuneNames[fortuneType]} ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);
            
            try {
                const res = await fetch('/api/saju/fortune', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        rawData: { userInfo: currentUserInfo },
                        fortuneType: fortuneType
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    appendMsg('ai', `ğŸ“Š **${data.fortuneType}**\n\n${data.fortune}`);
                } else {
                    appendMsg('ai', `ì˜¤ë¥˜ ë°œìƒ: ${data.error}`);
                }
            } catch (error) {
                console.error('Fortune API Error:', error);
                appendMsg('ai', 'ìš´ì„¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ========== Astrology Transit Functions ==========
        async function showAstrologyTransit(transitType) {
            if (!currentUserInfo) {
                appendMsg('ai', 'ë¨¼ì € ì ì„±í•™ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const transitNames = {
                'monthly': 'ì´ë²ˆ ë‹¬ í–‰ì„± ìš´í–‰',
                'yearly': 'ì˜¬í•´ í–‰ì„± ìš´í–‰',
                'decade': '10ë…„ í–‰ì„± ìš´í–‰'
            };

            appendMsg('ai', `ğŸŒŸ ${transitNames[transitType]} ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);
            
            try {
                const res = await fetch('/api/astrology/transit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        rawData: { userInfo: currentUserInfo },
                        transitType: transitType
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    appendMsg('ai', `ğŸŒŸ **${data.transitType}**\n\n${data.transit}`);
                } else {
                    appendMsg('ai', `ì˜¤ë¥˜ ë°œìƒ: ${data.error}`);
                }
            } catch (error) {
                console.error('Transit API Error:', error);
                appendMsg('ai', 'í–‰ì„± ìš´í–‰ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìš´ì„¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('DOMContentLoaded', function() {
            // ========== ë‹¬ë ¥ ì„ íƒê¸° ì´ˆê¸°í™” ==========
            createCalendarTypeSelector('s-cal-box', 'solar', true);     // ì‚¬ì£¼: ì–‘ë ¥/ìŒë ¥/ìŒë ¥(ìœ¤)
            createCalendarTypeSelector('c-cal-a', 'solar', true);       // ê¶í•© A: ì–‘ë ¥/ìŒë ¥/ìŒë ¥(ìœ¤)
            createCalendarTypeSelector('c-cal-b', 'solar', true);       // ê¶í•© B: ì–‘ë ¥/ìŒë ¥/ìŒë ¥(ìœ¤)
            createCalendarTypeSelector('a-cal-box', 'solar', true);     // ì ì„±í•™: ì–‘ë ¥/ìŒë ¥/ìŒë ¥(ìœ¤) (ì–‘ë ¥ ê¶Œì¥)
            
            // ========== ì±„íŒ… ë°•ìŠ¤ ìŠ¤í¬ë¡¤ ê°ì§€ ==========
            const chatBox = document.getElementById('chat-box');
            chatBox.addEventListener('scroll', function() {
                const isAtTop = chatBox.scrollTop < 100;
                const scrollTopBtn = document.getElementById('scroll-to-top-btn');
                
                // ë§¨ ìœ„ì— ìˆìœ¼ë©´ "ë§¨ ìœ„ë¡œ" ë²„íŠ¼ ìˆ¨ê¹€
                if (isAtTop && scrollTopBtn.style.display === 'block') {
                    hideScrollToTopButton();
                }
            });
            
            // ì‚¬ì£¼ ìš´ì„¸ ë²„íŠ¼
            const fortuneBtns = document.querySelectorAll('.fortune-btn');
            fortuneBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const fortuneType = this.dataset.fortune;
                    showFortuneByType(fortuneType);
                });
                
                // í˜¸ë²„ íš¨ê³¼
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                });
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            });

            // ì ì„±í•™ ìš´í–‰ ë²„íŠ¼
            const astrologyBtns = document.querySelectorAll('.astrology-btn');
            astrologyBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const transitType = this.dataset.transit;
                    showAstrologyTransit(transitType);
                });
                
                // í˜¸ë²„ íš¨ê³¼
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                });
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            });
        });
        
        // ì—”í„°í‚¤ ì…ë ¥ ì‹œ ì „ì†¡
        document.getElementById('user-msg').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>