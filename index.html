<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auriton InsightAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+KR:wght@300;500;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-deep: #0B0E14; --text-main: #e0e0e0; --primary-purple: #b026ff; --primary-cyan: #00f2ff; --primary-pink: #ff0055; --accent-gold: #ffd700; --glass: rgba(20, 15, 35, 0.8); }
        body { background: var(--bg-deep); color: var(--text-main); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; overflow-x: hidden; }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000 url('https://raw.githubusercontent.com/hudsonm62/stars/master/star_bg.png'); z-index: -2; opacity: 0.5; }
        
        /* UI Components */
        .screen { display: none; padding: 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header-title { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--accent-gold); text-align: center; margin: 40px 0 10px; text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .header-sub { text-align: center; color: var(--primary-cyan); font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 40px; opacity: 0.7; }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .method-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .method-card:hover { transform: translateY(-5px); border-color: var(--color); box-shadow: 0 0 20px var(--glow); }
        .icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        
        .form-box { background: rgba(10,10,20,0.95); border: 1px solid #333; border-radius: 12px; padding: 25px; border-top: 3px solid var(--theme); }
        .input-group { margin-bottom: 20px; }
        .label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; font-family: 'Orbitron'; }
        .input, .select { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; font-size: 1rem; outline: none; }
        .input:focus { border-color: var(--accent-gold); }
        
        .btn-group { display: flex; gap: 10px; }
        .opt-btn { flex: 1; padding: 12px; background: #1a1a1a; border: 1px solid #444; color: #aaa; border-radius: 6px; cursor: pointer; text-align: center; }
        .opt-btn.active { background: rgba(255,255,255,0.1); border-color: var(--accent-gold); color: var(--accent-gold); font-weight: bold; }
        
        .action-btn { width: 100%; padding: 16px; font-weight: bold; font-family: 'Orbitron'; cursor: pointer; border: none; border-radius: 6px; margin-top: 10px; transition: 0.2s; }
        .action-btn:active { transform: scale(0.98); }

        /* Compatibility Tabs */
        .tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #666; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab.active { color: var(--primary-pink); border-bottom: 2px solid var(--primary-pink); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Chat Result */
        .chat-container { border: 1px solid var(--primary-purple); background: rgba(0,0,0,0.8); height: 60vh; display: flex; flex-direction: column; border-radius: 8px; overflow: hidden; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; font-size: 0.95rem; line-height: 1.6; }
        .ai-msg { color: #ddd; margin-bottom: 20px; white-space: pre-wrap; animation: textFade 0.5s; border-left: 3px solid var(--accent-gold); padding-left: 15px; }
        .user-msg { color: var(--primary-cyan); text-align: right; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; display: inline-block; margin-left: auto; max-width: 80%; }
        .strong-hl { color: var(--accent-gold); font-weight: bold; }

        /* Chat Input Area */
        .chat-input-area { display: flex; border-top: 1px solid #333; padding: 10px; background: #050510; }
        .chat-input { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 4px; outline: none; }
        .send-btn { background: var(--accent-gold); color: black; font-weight: bold; border: none; padding: 0 20px; margin-left: 10px; border-radius: 4px; cursor: pointer; font-family: 'Orbitron'; }

        @media (max-width: 480px) { .header-title { font-size: 1.5rem; } }
    </style>
</head>
<body>
    <div class="stars"></div>

    <section id="screen-select" class="screen active">
        <h1 class="header-title">AURITON INSIGHT AI</h1>
        <p class="header-sub">DESTINY ANALYSIS SYSTEM</p>
        <div class="card-grid">
            <div class="method-card" onclick="goSaju()" style="--color:var(--primary-purple); --glow:rgba(176,38,255,0.3)">
                <span class="icon">ğŸ”®</span>
                <h3>ì •í†µ ì‚¬ì£¼ & ëŒ€ìš´</h3>
                <p style="font-size:0.8rem; color:#888; margin-top:10px">íƒ€ê³ ë‚œ ëª…ì‹ê³¼<br>10ë…„ ëŒ€ìš´ì˜ íë¦„ ë¶„ì„</p>
            </div>
            <div class="method-card" onclick="goCouple()" style="--color:var(--primary-pink); --glow:rgba(255,0,85,0.3)">
                <span class="icon">ğŸ’</span>
                <h3>ìš´ëª… ê¶í•©</h3>
                <p style="font-size:0.8rem; color:#888; margin-top:10px">ë‘ ì‚¬ëŒì˜ ì—ë„ˆì§€ ì¡°í™”ì™€<br>ê´€ê³„ ë°œì „ ì¡°ì–¸</p>
            </div>
            <div class="method-card" onclick="alert('ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')" style="--color:var(--primary-cyan); --glow:rgba(0,242,255,0.3)">
                <span class="icon">ğŸŒŒ</span>
                <h3>ì„œì–‘ ì ì„±ìˆ </h3>
                <p style="font-size:0.8rem; color:#888; margin-top:10px">ë³„ë“¤ì˜ ë°°ì¹˜ë¡œ ë³´ëŠ”<br>ë‚´ë©´ì˜ ì‹¬ë¦¬ ë¶„ì„</p>
            </div>
        </div>
    </section>

    <section id="screen-saju" class="screen">
        <button onclick="goHome()" style="color:#666; background:none; border:none; margin-bottom:10px">â—€ BACK</button>
        <div class="form-box" style="--theme:var(--primary-purple)">
            <h2 style="color:white; margin-bottom:20px; font-family:'Orbitron'">SAJU DATA</h2>
            <form id="form-saju" onsubmit="submitSaju(event)">
                <div class="input-group"><label class="label">NAME</label><input type="text" id="s-name" class="input" required></div>
                <div class="input-group"><label class="label">GENDER</label>
                    <div class="btn-group" id="s-gender-box"><div class="opt-btn active" data-val="male">ë‚¨ì„± (M)</div><div class="opt-btn" data-val="female">ì—¬ì„± (F)</div></div>
                </div>
                <div class="input-group"><label class="label">BIRTH DATE (YYYY-MM-DD)</label>
                    <div style="display:flex; gap:5px">
                        <input type="number" id="s-y" class="input" placeholder="Year" style="flex:1.5" required>
                        <input type="number" id="s-m" class="input" placeholder="Mon" style="flex:1" required>
                        <input type="number" id="s-d" class="input" placeholder="Day" style="flex:1" required>
                    </div>
                </div>
                <div class="input-group"><label class="label">BIRTH TIME</label>
                    <input type="time" id="s-time" class="input" required>
                </div>
                <div class="input-group"><label class="label">CALENDAR TYPE</label>
                    <div class="btn-group" id="s-cal-box">
                        <div class="opt-btn active" data-val="solar">ì–‘ë ¥</div>
                        <div class="opt-btn" data-val="lunar">ìŒë ¥</div>
                        <div class="opt-btn" data-val="lunar-leap">ìŒë ¥(ìœ¤)</div>
                    </div>
                </div>
                <button type="submit" class="action-btn" style="background:var(--primary-purple); color:white">ANALYZE â–¶</button>
            </form>
        </div>
    </section>

    <section id="screen-couple" class="screen">
        <button onclick="goHome()" style="color:#666; background:none; border:none; margin-bottom:10px">â—€ BACK</button>
        <div class="form-box" style="--theme:var(--primary-pink)">
            <h2 style="color:white; margin-bottom:20px; font-family:'Orbitron'">COUPLE DATA</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('A')">Person A (ë‚˜)</div>
                <div class="tab" onclick="switchTab('B')">Person B (ìƒëŒ€)</div>
            </div>

            <div id="tab-A" class="tab-content active">
                <div class="input-group"><label class="label">NAME</label><input type="text" id="c-name-a" class="input" placeholder="ë‚´ ì´ë¦„"></div>
                <div class="input-group"><label class="label">GENDER</label><select id="c-gender-a" class="select"><option value="male">ë‚¨ì„±</option><option value="female">ì—¬ì„±</option></select></div>
                <div class="input-group"><label class="label">DATE</label><div style="display:flex; gap:5px"><input type="number" id="c-y-a" class="input" placeholder="YYYY"><input type="number" id="c-m-a" class="input" placeholder="MM"><input type="number" id="c-d-a" class="input" placeholder="DD"></div></div>
                <div class="input-group"><label class="label">TIME</label><input type="time" id="c-time-a" class="input"></div>
                <div class="action-btn" onclick="switchTab('B')" style="background:#333; color:#fff; text-align:center; margin-top:20px">NEXT: ìƒëŒ€ë°© ì…ë ¥ â–¶</div>
            </div>

            <div id="tab-B" class="tab-content">
                <div class="input-group"><label class="label">NAME</label><input type="text" id="c-name-b" class="input" placeholder="ìƒëŒ€ë°© ì´ë¦„"></div>
                <div class="input-group"><label class="label">GENDER</label><select id="c-gender-b" class="select"><option value="female" selected>ì—¬ì„±</option><option value="male">ë‚¨ì„±</option></select></div>
                <div class="input-group"><label class="label">DATE</label><div style="display:flex; gap:5px"><input type="number" id="c-y-b" class="input" placeholder="YYYY"><input type="number" id="c-m-b" class="input" placeholder="MM"><input type="number" id="c-d-b" class="input" placeholder="DD"></div></div>
                <div class="input-group"><label class="label">TIME</label><input type="time" id="c-time-b" class="input"></div>
                <button onclick="submitCouple()" class="action-btn" style="background:var(--primary-pink); color:white; margin-top:20px">CHECK COMPATIBILITY â¤</button>
            </div>
        </div>
    </section>

    <section id="screen-result" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h2 class="header-sub" style="margin:0; text-align:left">ANALYSIS RESULT</h2>
            <button onclick="goHome()" style="background:none; border:1px solid #444; color:#888; padding:5px 10px; font-size:0.7rem">NEW SCAN</button>
        </div>
        
        <!-- Fortune Type Buttons (ì‚¬ì£¼ ë¶„ì„ í›„ì—ë§Œ í‘œì‹œ) -->
        <div id="fortune-buttons" style="display:none; margin-bottom:20px; background:rgba(20,15,35,0.6); padding:15px; border-radius:8px; border:1px solid rgba(176,38,255,0.3)">
            <div style="text-align:center; color:#ffd700; font-size:0.8rem; margin-bottom:12px; font-family:'Orbitron'">ğŸ“Š ìš´ì„¸ ìƒì„¸ ë¶„ì„</div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px">
                <button class="fortune-btn" data-fortune="daily" style="padding:10px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì¼ê°„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="weekly" style="padding:10px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì£¼ê°„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="monthly" style="padding:10px; background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì›”ê°„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="yearly" style="padding:10px; background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì˜¬í•´ì˜ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="decade" style="padding:10px; background:linear-gradient(135deg, #fa709a 0%, #fee140 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    10ë…„ ìš´ì„¸
                </button>
                <button class="fortune-btn" data-fortune="total" style="padding:10px; background:linear-gradient(135deg, #30cfd0 0%, #330867 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:bold; transition:0.2s">
                    ì´ìš´
                </button>
            </div>
        </div>
        
        <div class="chat-container">
            <div id="chat-box" class="chat-box"></div>
            <div class="chat-input-area" id="chat-input-area">
                <input type="text" id="user-msg" class="chat-input" placeholder="ì¶”ê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2026ë…„ ì¬ë¬¼ìš´ì€?)">
                <button onclick="sendChat()" class="send-btn">SEND</button>
            </div>
        </div>
    </section>
    </section>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ì´ê²Œ ìˆì–´ì•¼ ì±„íŒ…ì´ ë©ë‹ˆë‹¤!)
        let currentMode = ''; // 'saju' or 'couple'
        let currentUserInfo = null; // ì‚¬ì£¼ìš©
        let currentCoupleInfo = null; // ê¶í•©ìš©

        // --- Navigation ---
        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
        }
        function goHome() { 
            showScreen('screen-select'); 
            document.getElementById('chat-box').innerHTML = ''; // ì±„íŒ… ì´ˆê¸°í™”
            currentUserInfo = null; // ë°ì´í„° ì´ˆê¸°í™”
            currentCoupleInfo = null;
        }
        function goSaju() { currentMode = 'saju'; showScreen('screen-saju'); }
        function goCouple() { currentMode = 'couple'; showScreen('screen-couple'); }

        // --- UI Helpers ---
        document.querySelectorAll('.btn-group .opt-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function switchTab(target) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll(`.tab:nth-child(${target === 'A' ? 1 : 2})`)[0].classList.add('active');
            document.getElementById(`tab-${target}`).classList.add('active');
        }

        function appendMsg(sender, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            // AI ë©”ì‹œì§€ëŠ” ì¤„ë°”ê¿ˆ ì²˜ë¦¬ ë° ê°•ì¡° í‘œì‹œ
            if (sender === 'ai') {
                div.className = 'ai-msg';
                div.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<span class="strong-hl">$1</span>');
            } else {
                div.className = 'user-msg';
                div.textContent = text;
            }
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- API Calls ---
        // 1. ê°œì¸ ì‚¬ì£¼ ë¶„ì„
        async function submitSaju(e) {
            // ì‚¬ì£¼ ë¶„ì„ ì„±ê³µ ì‹œ ìš´ì„¸ ë²„íŠ¼ í‘œì‹œ
            currentMode = "saju";
            document.getElementById("fortune-buttons").style.display = "block";
            e.preventDefault();
            const name = document.getElementById('s-name').value;
            const gender = document.querySelector('#s-gender-box .active').dataset.val;
            const cal = document.querySelector('#s-cal-box .active').dataset.val;
            const y = document.getElementById('s-y').value;
            const m = document.getElementById('s-m').value;
            const d = document.getElementById('s-d').value;
            const t = document.getElementById('s-time').value;

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì±„íŒ…í•  ë•Œ ì”ë‹ˆë‹¤!)
            currentUserInfo = { name, gender, birthDate: `${y}-${m}-${d}`, birthTime: t, calendarType: cal };
            
            showScreen('screen-result');
            // ê¶í•© ëª¨ë“œì¼ ë•ŒëŠ” ì±„íŒ…ì°½ ìˆ¨ê¹€ (ë³µì¡í•´ì„œ ì¼ë‹¨ ë¹„í™œì„±í™” ì¶”ì²œ)
            document.getElementById('chat-input-area').style.display = 'flex';
            
            appendMsg('ai', "ğŸ”® ìš´ëª…ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...\n(ëŒ€ìš´ íë¦„ ê³„ì‚° ì¤‘)");

            try {
                const res = await fetch('/api/saju/consultation', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ rawData: { userInfo: currentUserInfo } })
                });
                const data = await res.json();
                appendMsg('ai', data.consultation);
            } catch(err) { appendMsg('ai', "ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        }

        // 2. ê¶í•© ë¶„ì„
        async function submitCouple() {
            const aInfo = {
                name: document.getElementById('c-name-a').value,
                gender: document.getElementById('c-gender-a').value,
                birthDate: `${document.getElementById('c-y-a').value}-${document.getElementById('c-m-a').value}-${document.getElementById('c-d-a').value}`,
                birthTime: document.getElementById('c-time-a').value,
                calendarType: 'solar'
            };
            const bInfo = {
                name: document.getElementById('c-name-b').value,
                gender: document.getElementById('c-gender-b').value,
                birthDate: `${document.getElementById('c-y-b').value}-${document.getElementById('c-m-b').value}-${document.getElementById('c-d-b').value}`,
                birthTime: document.getElementById('c-time-b').value,
                calendarType: 'solar'
            };

            if(!aInfo.name || !bInfo.name || aInfo.birthDate.length < 8 || bInfo.birthDate.length < 8) {
                alert("ë‘ ì‚¬ëŒì˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
            }

            // ê¶í•© ëª¨ë“œ
            currentCoupleInfo = { personA: aInfo, personB: bInfo };
            showScreen('screen-result');
            // ê¶í•© ì±„íŒ…ì€ ë³µì¡ë„ê°€ ë†’ì•„ ì¼ë‹¨ ìˆ¨ê¹€ (í•„ìš”ì‹œ í™œì„±í™” ê°€ëŠ¥)
            document.getElementById('chat-input-area').style.display = 'none';

            appendMsg('ai', "ğŸ’ ë‘ ì‚¬ëŒì˜ ì—ë„ˆì§€ë¥¼ ë™ê¸°í™”í•˜ì—¬ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");

            try {
                const res = await fetch('/api/saju/compatibility', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ personA: aInfo, personB: bInfo })
                });
                const data = await res.json();
                appendMsg('ai', data.consultation);
            } catch(err) { appendMsg('ai', "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        }

        // 3. ì±„íŒ… ì „ì†¡ (ì—¬ê¸°ê°€ í•µì‹¬!)
        async function sendChat() {
            const input = document.getElementById('user-msg');
            const msg = input.value.trim();
            if (!msg) return;

            // ë‚´ê°€ ì“´ ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
            appendMsg('user', msg);
            input.value = '';

            // ì„œë²„ë¡œ ì „ì†¡ (currentUserInfoë¥¼ ê°™ì´ ë³´ëƒ…ë‹ˆë‹¤!)
            if (currentMode === 'saju' && currentUserInfo) {
                try {
                    const res = await fetch('/api/saju/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userMessage: msg, 
                            rawData: { userInfo: currentUserInfo } // â˜… í•µì‹¬: ìœ ì € ì •ë³´ ì¬ì „ì†¡
                        })
                    });
                    const data = await res.json();
                    appendMsg('ai', data.answer);
                } catch (e) {
                    appendMsg('ai', "ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                appendMsg('ai', "ë¶„ì„ ë°ì´í„°ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
            }
        }
        
        // ì—”í„°í‚¤ ì…ë ¥ ì‹œ ì „ì†¡
        document.getElementById('user-msg').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>