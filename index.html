<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ultra Dosa Sentinel</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëÅÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Noto+Sans+KR:wght@300;400;500;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* [Ïä§ÌÉÄÏùº Ïú†ÏßÄ] Deep Night Theme */
        :root {
            --bg-deep: #0B0E14;
            --text-main: #e0e0e0;
            --primary-purple: #b026ff;
            --primary-cyan: #00f2ff;
            --accent-gold: #ffd700;
            --glass-panel: rgba(20, 15, 35, 0.75);
            --border-glow: rgba(176, 38, 255, 0.5);
            --font-ancient: 'Cinzel', serif;
            --font-tech: 'Orbitron', sans-serif;
            --font-body: 'Noto Sans KR', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background-color: var(--bg-deep); color: var(--text-main); font-family: var(--font-body); 
            overflow-x: hidden; min-height: 100vh; position: relative; 
        }
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: #000 radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)), 
                        radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0));
            background-size: 200px 200px;
        }
        .twinkling {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 50%, rgba(176, 38, 255, 0.1), transparent 70%);
            animation: pulse 5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 0.6; } 100% { opacity: 0.3; } }

        .site-header { text-align: center; padding: 60px 20px; }
        .site-title { font-family: var(--font-ancient); font-size: 3rem; color: var(--accent-gold); text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); letter-spacing: 2px; margin-bottom: 10px; }
        .site-subtitle { font-family: var(--font-tech); color: var(--primary-cyan); font-size: 0.9rem; letter-spacing: 3px; opacity: 0.8; }

        .main-container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }
        .screen { display: none; animation: fadeScale 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .screen.active { display: block; }
        @keyframes fadeScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* ÏÑ†ÌÉù Ïπ¥Îìú */
        .selection-content { text-align: center; }
        .section-title { font-family: var(--font-ancient); font-size: 1.8rem; margin-bottom: 10px; color: #fff; }
        .section-desc { color: #888; margin-bottom: 40px; }
        .method-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .method-card { background: var(--glass-panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 40px 20px; cursor: pointer; transition: 0.4s; }
        .method-card:hover { transform: translateY(-5px); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .saju-card:hover { border-color: var(--primary-purple); box-shadow: 0 0 30px rgba(176,38,255,0.2); }
        .astro-card:hover { border-color: var(--primary-cyan); box-shadow: 0 0 30px rgba(0,242,255,0.2); }
        .card-icon { font-size: 3rem; margin-bottom: 20px; }
        .card-title { font-family: var(--font-tech); font-size: 1.5rem; margin-bottom: 5px; color: #fff; }
        .card-button { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 10px 30px; font-family: var(--font-tech); transition: 0.3s; pointer-events: none; }
        .saju-card:hover .card-button { background: var(--primary-purple); border-color: var(--primary-purple); }
        .astro-card:hover .card-button { background: var(--primary-cyan); border-color: var(--primary-cyan); color: #000; }

        /* Ìèº Ïä§ÌÉÄÏùº */
        .form-container { background: rgba(10, 10, 20, 0.9); border: 1px solid #333; padding: 40px; border-radius: 4px; }
        .saju-theme { border-top: 3px solid var(--primary-purple); }
        .astro-theme { border-top: 3px solid var(--primary-cyan); }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .form-title { font-family: var(--font-tech); font-size: 1.8rem; color: #fff; }
        .form-label { display: block; font-family: var(--font-tech); font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 12px; font-size: 1rem; outline: none; }
        .form-input:focus, .form-select:focus { border-color: var(--accent-gold); }
        .form-group { margin-bottom: 25px; }
        .button-group, .select-group { display: flex; gap: 10px; }
        .select-group select { flex: 1; }
        .option-button { flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: #aaa; cursor: pointer; font-family: var(--font-tech); }
        .option-button.active { background: rgba(255,255,255,0.1); border-color: var(--accent-gold); color: var(--accent-gold); }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #ccc; font-size: 0.9rem; margin-top: 10px; }
        .checkbox-label input { width: 16px; height: 16px; accent-color: var(--accent-gold); }
        .form-hint { font-size: 0.8rem; color: #00f2ff; margin-top: 5px; }
        .submit-button { width: 100%; padding: 15px; margin-top: 20px; font-family: var(--font-tech); font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        .saju-btn { background: var(--primary-purple); color: #fff; }
        .astro-btn { background: var(--primary-cyan); color: #000; }
        .submit-button:hover { filter: brightness(1.2); }
        .back-button { background: none; border: none; color: #666; cursor: pointer; font-family: var(--font-tech); margin-bottom: 20px; }
        .back-button:hover { color: #fff; }

        /* Í≤∞Í≥º ÌôîÎ©¥ */
        .hud-interface { border: 1px solid var(--border-glow); background: rgba(5, 5, 10, 0.95); padding: 20px; position: relative; box-shadow: 0 0 50px rgba(176, 38, 255, 0.1); min-height: 600px; display: flex; flex-direction: column; }
        .result-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
        .result-title { font-family: var(--font-tech); color: var(--accent-gold); letter-spacing: 2px; }
        .new-analysis-button { background: transparent; border: 1px solid #555; color: #888; padding: 5px 15px; cursor: pointer; font-family: var(--font-tech); font-size: 0.8rem; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; margin-bottom: 20px; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 20px 20px; }
        .ai-message { color: #e0e0e0; margin-bottom: 20px; white-space: pre-wrap; border-left: 3px solid var(--accent-gold); padding-left: 15px; }
        .user-message { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 10px; color: var(--primary-cyan); text-align: right; width: fit-content; margin-left: auto; margin-bottom: 20px; }
        .chat-input-area { display: flex; gap: 10px; border-top: 1px solid #333; padding-top: 15px; }
        .chat-input { flex: 1; background: #111; border: 1px solid #444; color: #fff; padding: 12px; }
        .send-button { background: var(--accent-gold); border: none; color: #000; padding: 0 25px; font-weight: bold; cursor: pointer; font-family: var(--font-tech); }
        .hud-corner { position: absolute; width: 20px; height: 20px; border: 2px solid var(--accent-gold); }
        .top-left { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .top-right { top: -2px; right: -2px; border-left: none; border-bottom: none; }
        .bottom-left { bottom: -2px; left: -2px; border-right: none; border-top: none; }
        .bottom-right { bottom: -2px; right: -2px; border-left: none; border-top: none; }
        @media (max-width: 768px) { .method-grid { grid-template-columns: 1fr; } .site-title { font-size: 2rem; } }
    </style>
</head>
<body>
    
    <div class="stars"></div>
    <div class="twinkling"></div>
    
    <header class="site-header">
        <h1 class="site-title">AI ULTRA DOSA SENTINEL</h1>
        <p class="site-subtitle">The Convergence of Ancient Wisdom & Future Intelligence</p>
    </header>
    
    <main class="main-container">
        <section id="selection-screen" class="screen active">
            <div class="selection-content">
                <h2 class="section-title">CHOOSE YOUR DESTINY</h2>
                <p class="section-desc">Ïö¥Î™ÖÏùÑ Ìï¥ÏÑùÌï† ÌîÑÎ°úÌÜ†ÏΩúÏùÑ ÏÑ†ÌÉùÌïòÏã≠ÏãúÏò§</p>
                <div class="method-grid">
                    <div class="method-card saju-card" onclick="selectMethod('saju')">
                        <div class="card-icon">üîÆ</div>
                        <h3 class="card-title">SAJU PROTOCOL</h3>
                        <ul class="card-features"><li>ÏÇ¨Ï£ºÌåîÏûê (Four Pillars) Ìï¥ÏÑù</li><li>Ïò§Ìñâ (Five Elements) Í∑†Ìòï</li></ul>
                        <button class="card-button saju-btn">INITIALIZE ‚ñ∂</button>
                    </div>
                    <div class="method-card astro-card" onclick="selectMethod('astrology')">
                        <div class="card-icon">üåå</div>
                        <h3 class="card-title">ASTRO PROTOCOL</h3>
                        <ul class="card-features"><li>Ï∂úÏÉù Ï∞®Ìä∏ (Natal Chart) ÎîîÏΩîÎî©</li><li>ÌñâÏÑ± Î∞∞ÏπòÏôÄ ÌïòÏö∞Ïä§ Î∂ÑÏÑù</li></ul>
                        <button class="card-button astro-btn">INITIALIZE ‚ñ∂</button>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="saju-screen" class="screen">
            <button class="back-button" onclick="backToSelection()">‚óÄ ABORT</button>
            <div class="form-container saju-theme">
                <div class="form-header"><h2 class="form-title">SAJU SEQUENCE</h2></div>
                <form id="saju-form">
                    <div class="form-group"><label class="form-label">CODENAME</label><input type="text" id="saju-name" class="form-input" required></div>
                    <div class="form-group"><label class="form-label">GENDER</label>
                        <div class="button-group" id="saju-gender-group">
                            <button type="button" class="option-button active" data-value="male">MALE</button>
                            <button type="button" class="option-button" data-value="female">FEMALE</button>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">CALENDAR</label>
                        <div class="button-group" id="saju-calendar-group">
                            <button type="button" class="option-button active" data-value="solar">SOLAR (ÏñëÎ†•)</button>
                            <button type="button" class="option-button" data-value="lunar">LUNAR (ÏùåÎ†•)</button>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">DATE</label>
                        <div class="select-group">
                            <select id="saju-year" class="form-select" required></select>
                            <select id="saju-month" class="form-select" required></select>
                            <select id="saju-day" class="form-select" required></select>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">TIME</label>
                        <select id="saju-time" class="form-select" required>
                            <option value="unknown">ÏãúÍ∞Ñ Î™®Î¶Ñ</option>
                            <option value="ÏûêÏãú">ÏûêÏãú (23:30~01:29)</option><option value="Ï∂ïÏãú">Ï∂ïÏãú (01:30~03:29)</option>
                            <option value="Ïù∏Ïãú">Ïù∏Ïãú (03:30~05:29)</option><option value="Î¨òÏãú">Î¨òÏãú (05:30~07:29)</option>
                            <option value="ÏßÑÏãú">ÏßÑÏãú (07:30~09:29)</option><option value="ÏÇ¨Ïãú">ÏÇ¨Ïãú (09:30~11:29)</option>
                            <option value="Ïò§Ïãú">Ïò§Ïãú (11:30~13:29)</option><option value="ÎØ∏Ïãú">ÎØ∏Ïãú (13:30~15:29)</option>
                            <option value="Ïã†Ïãú">Ïã†Ïãú (15:30~17:29)</option><option value="Ïú†Ïãú">Ïú†Ïãú (17:30~19:29)</option>
                            <option value="Ïà†Ïãú">Ïà†Ïãú (19:30~21:29)</option><option value="Ìï¥Ïãú">Ìï¥Ïãú (21:30~23:29)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" id="saju-privacy" required><span>AGREE TO DATA PROCESSING</span></label>
                    </div>
                    <button type="submit" class="submit-button saju-btn">ACTIVATE ANALYSIS</button>
                </form>
            </div>
        </section>
        
        <section id="astrology-screen" class="screen">
            <button class="back-button" onclick="backToSelection()">‚óÄ ABORT</button>
            <div class="form-container astro-theme">
                <div class="form-header"><h2 class="form-title">ASTRO SEQUENCE</h2></div>
                <form id="astro-form">
                    <div class="form-group"><label class="form-label">CODENAME</label><input type="text" id="astro-name" class="form-input" required></div>
                    <div class="form-group"><label class="form-label">GENDER</label>
                        <div class="button-group" id="astro-gender-group">
                            <button type="button" class="option-button active" data-value="male">MALE</button>
                            <button type="button" class="option-button" data-value="female">FEMALE</button>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">DATE (Solar Only)</label>
                        <div class="select-group">
                            <select id="astro-year" class="form-select" required></select>
                            <select id="astro-month" class="form-select" required></select>
                            <select id="astro-day" class="form-select" required></select>
                        </div>
                        <p class="form-hint">‚Äª Ï†êÏÑ±Ïà†ÏùÄ 'ÏñëÎ†•(Solar)' Í∏∞Ï§ÄÏûÖÎãàÎã§.</p>
                    </div>
                    <div class="form-group">
                        <label class="input-label">
                            <i class="fas fa-clock"></i> ÌÉúÏñ¥ÎÇú ÏãúÍ∞Ñ
                        </label>
                        <div class="time-selector-group">
                            <input type="time" id="astro-time" required style="width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--neon-blue); color: #fff; border-radius: 8px; font-size: 1.1rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" id="astro-privacy" required><span>AGREE TO DATA PROCESSING</span></label>
                    </div>
                    <button type="submit" class="submit-button astro-btn">ACTIVATE ANALYSIS</button>
                </form>
            </div>
        </section>

        <section id="result-screen" class="screen">
            <div class="hud-interface">
                <div class="hud-corner top-left"></div><div class="hud-corner top-right"></div>
                <div class="hud-corner bottom-left"></div><div class="hud-corner bottom-right"></div>
                <div class="result-header">
                    <h2 class="result-title">ANALYSIS COMPLETE</h2>
                    <button class="new-analysis-button" onclick="backToSelection()">NEW SCAN</button>
                </div>
                <div id="chat-box" class="chat-messages">
                    <div class="ai-message">ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å. Ïö¥Î™Ö Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="user-input" class="chat-input" placeholder="Ï∂îÍ∞Ä ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
                    <button id="send-btn" class="send-button">SEND</button>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="site-footer">¬© 2026 AI ULTRA DOSA SENTINEL.</footer>

    <script>
        // === 1. Í≥ÑÏÇ∞ Î°úÏßÅ (ÏÇ¨Ï£º/Ï†êÏÑ±Ïà† Î™®Îìà) ===
        // ÏÇ¨Ï£º: Ï≤úÍ∞Ñ/ÏßÄÏßÄ Îç∞Ïù¥ÌÑ∞
        const HEAVENLY_STEMS = ['Í∞ë','ÏùÑ','Î≥ë','Ï†ï','Î¨¥','Í∏∞','Í≤Ω','Ïã†','ÏûÑ','Í≥Ñ'];
        const EARTHLY_BRANCHES = ['Ïûê','Ï∂ï','Ïù∏','Î¨ò','ÏßÑ','ÏÇ¨','Ïò§','ÎØ∏','Ïã†','Ïú†','Ïà†','Ìï¥'];
        const FIVE_ELEMENTS = {
            'Í∞ë':'Î™©','ÏùÑ':'Î™©','Î≥ë':'Ìôî','Ï†ï':'Ìôî','Î¨¥':'ÌÜ†','Í∏∞':'ÌÜ†','Í≤Ω':'Í∏à','Ïã†':'Í∏à','ÏûÑ':'Ïàò','Í≥Ñ':'Ïàò',
            'Ïù∏':'Î™©','Î¨ò':'Î™©','ÏÇ¨':'Ìôî','Ïò§':'Ìôî','ÏßÑ':'ÌÜ†','Ïà†':'ÌÜ†','Ï∂ï':'ÌÜ†','ÎØ∏':'ÌÜ†','Ïã†':'Í∏à','Ïú†':'Í∏à','Ïûê':'Ïàò','Ìï¥':'Ïàò'
        };

        // Ï†êÏÑ±Ïà†: Î≥ÑÏûêÎ¶¨ Îç∞Ïù¥ÌÑ∞
        const ZODIAC = ['Ïñë','Ìô©ÏÜå','ÏåçÎë•Ïù¥','Í≤å','ÏÇ¨Ïûê','Ï≤òÎÖÄ','Ï≤úÏπ≠','Ï†ÑÍ∞à','ÏÇ¨Ïàò','ÏóºÏÜå','Î¨ºÎ≥ë','Î¨ºÍ≥†Í∏∞'];

        function getPillar(idx, offset) {
            return {
                stem: HEAVENLY_STEMS[(idx + offset) % 10],
                branch: EARTHLY_BRANCHES[(idx + offset) % 12],
                full: HEAVENLY_STEMS[(idx + offset) % 10] + EARTHLY_BRANCHES[(idx + offset) % 12]
            };
        }

        // ÏÇ¨Ï£º Í≥ÑÏÇ∞ (Í∞ÑÏù¥ Î°úÏßÅ)
        function calculateSaju(y, m, d, h) {
            const yearP = getPillar(y - 4, 0);
            const monthP = getPillar((y - 4) * 12 + m, 2);
            const dayP = getPillar((y * 365 + d), 4);
            const hIdx = (['Ïûê','Ï∂ï','Ïù∏','Î¨ò','ÏßÑ','ÏÇ¨','Ïò§','ÎØ∏','Ïã†','Ïú†','Ïà†','Ìï¥'].indexOf(h));
            const hourP = hIdx >= 0 ? getPillar(hIdx, 0) : {full:'ÏãúÍ∞ÑÎ™®Î¶Ñ'};
            
            const els = {'Î™©':0,'Ìôî':0,'ÌÜ†':0,'Í∏à':0,'Ïàò':0};
            [yearP, monthP, dayP].forEach(p => {
                if(p.stem) els[FIVE_ELEMENTS[p.stem]]++;
                if(p.branch) els[FIVE_ELEMENTS[p.branch]]++;
            });

            return {
                fourPillars: `${yearP.full} ${monthP.full} ${dayP.full} ${hourP.full}`,
                dayPillar: dayP,
                elements: els
            };
        }

        // Ï†êÏÑ±Ïà† Í≥ÑÏÇ∞ (Í∞ÑÏù¥ Î°úÏßÅ)
        function calculateAstrology(y, m, d) {
            const sunIdx = (m - 3 + 12) % 12;
            const moonIdx = (d % 27) / 2.5; 
            const ascIdx = (sunIdx + 2) % 12; // ÏûÑÏùò Ïò§ÌîÑÏÖã
            
            const getSign = (idx) => ({ name: ZODIAC[Math.floor(idx) % 12] + 'ÏûêÎ¶¨' });
            return {
                sun: { sign: getSign(sunIdx) },
                moon: { sign: getSign(moonIdx) },
                ascendant: { sign: getSign(ascIdx) }
            };
        }

        // === 2. Î©îÏù∏ UI Î°úÏßÅ ===
        let currentMode = '';
        let currentUserInfo = {};
        let currentRawData = {}; // ÏÑúÎ≤ÑÎ°ú Î≥¥ÎÇº Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞

        function selectMethod(method) {
            currentMode = method;
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            if (method === 'saju') document.getElementById('saju-screen').classList.add('active');
            if (method === 'astrology') document.getElementById('astrology-screen').classList.add('active');
        }

        function backToSelection() {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('selection-screen').classList.add('active');
            document.getElementById('chat-box').innerHTML = '';
        }

        function showResultScreen() {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('result-screen').classList.add('active');
        }

        function appendMessage(sender, text) {
            const chatBox = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = sender === 'user' ? 'user-message' : 'ai-message';
            msgDiv.innerHTML = text.replace(/\n/g, '<br>');
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function callApi(endpoint, data) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error(error);
                return { success: false, error: 'ÏÑúÎ≤Ñ ÌÜµÏã† Ïò§Î•ò' };
            }
        }

        function setupOptionButtons(id) {
            const group = document.getElementById(id);
            if(!group) return;
            const btns = group.querySelectorAll('.option-button');
            btns.forEach(btn => btn.addEventListener('click', () => {
                btns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }));
        }

        function populateDateSelects() {
            const targetIds = [ { y: 'saju-year', m: 'saju-month', d: 'saju-day' }, { y: 'astro-year', m: 'astro-month', d: 'astro-day' } ];
            targetIds.forEach(target => {
                const ySel = document.getElementById(target.y);
                const mSel = document.getElementById(target.m);
                const dSel = document.getElementById(target.d);
                if(ySel) for(let i=2026; i>=1920; i--) { let opt=document.createElement('option'); opt.value=i; opt.innerHTML=i+"ÎÖÑ"; ySel.appendChild(opt); }
                if(mSel) for(let i=1; i<=12; i++) { let opt=document.createElement('option'); opt.value=i; opt.innerHTML=i+"Ïõî"; mSel.appendChild(opt); }
                if(dSel) for(let i=1; i<=31; i++) { let opt=document.createElement('option'); opt.value=i; opt.innerHTML=i+"Ïùº"; dSel.appendChild(opt); }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupOptionButtons('saju-gender-group');
            setupOptionButtons('saju-calendar-group');
            setupOptionButtons('astro-gender-group');
            populateDateSelects();

            // [ÏÇ¨Ï£º Ìèº Ï†úÏ∂ú]
            document.getElementById('saju-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!document.getElementById('saju-privacy').checked) { alert('Í∞úÏù∏Ï†ïÎ≥¥ ÎèôÏùò ÌïÑÏöî'); return; }
                
                const name = document.getElementById('saju-name').value;
                const gender = document.querySelector('#saju-gender-group .active').dataset.value;
                const y = parseInt(document.getElementById('saju-year').value);
                const m = parseInt(document.getElementById('saju-month').value);
                const d = parseInt(document.getElementById('saju-day').value);
                const time = document.getElementById('saju-time').value;

                // 1. Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                currentUserInfo = { name, gender, birthDate: `${y}-${m}-${d}`, birthTime: time };
                // 2. ÏÇ¨Ï£º Í≥ÑÏÇ∞ ÏàòÌñâ
                const sajuResult = calculateSaju(y, m, d, time);
                // 3. ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°Ìï† Ìå®ÌÇ§ÏßÄ Íµ¨ÏÑ±
                currentRawData = { userInfo: currentUserInfo, saju: sajuResult };

                showResultScreen();
                appendMessage('ai', 'Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ï§ë... ÏÇ¨Ï£ºÎ™ÖÏ°∞Î•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§.');
                
                const res = await callApi('/api/saju/consultation', { rawData: currentRawData });
                appendMessage('ai', res.success ? res.consultation : 'Ïò§Î•ò: ' + res.error);
            });

            // [Ï†êÏÑ±Ïà† Ìèº Ï†úÏ∂ú]
            document.getElementById('astro-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!document.getElementById('astro-privacy').checked) { alert('Í∞úÏù∏Ï†ïÎ≥¥ ÎèôÏùò ÌïÑÏöî'); return; }

                const name = document.getElementById('astro-name').value;
                const gender = document.querySelector('#astro-gender-group .active').dataset.value;
                const y = parseInt(document.getElementById('astro-year').value);
                const m = parseInt(document.getElementById('astro-month').value);
                const d = parseInt(document.getElementById('astro-day').value);
                const time = document.getElementById('astro-time').value;

                currentUserInfo = { name, gender, birthDate: `${y}-${m}-${d}`, birthTime: time };
                // Ï†êÏÑ±Ïà† Í≥ÑÏÇ∞ ÏàòÌñâ
                const astroResult = calculateAstrology(y, m, d);
                currentRawData = { userInfo: currentUserInfo, astrology: astroResult };
                
                showResultScreen();
                appendMessage('ai', 'Î≥ÑÎì§Ïùò ÏúÑÏπòÎ•º Í≥ÑÏÇ∞ Ï§ëÏûÖÎãàÎã§...');
                
                const res = await callApi('/api/astrology/consultation', { rawData: currentRawData });
                appendMessage('ai', res.success ? res.consultation : 'Ïò§Î•ò: ' + res.error);
            });

            // [Ï±ÑÌåÖ Ï†ÑÏÜ°]
            document.getElementById('send-btn').addEventListener('click', async () => {
                const input = document.getElementById('user-input');
                const msg = input.value.trim();
                if (!msg) return;
                appendMessage('user', msg);
                input.value = '';
                
                const endpoint = currentMode === 'saju' ? '/api/saju/chat' : '/api/astrology/chat';
                const res = await callApi(endpoint, { userMessage: msg, rawData: currentRawData });
                appendMessage('ai', res.success ? res.answer : 'ÏùëÎãµ Ïã§Ìå®');
            });
        });
    </script>
</body>
</html>